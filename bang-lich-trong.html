<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ch·ªçn gi·ªù - SportField</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .page-header {
      background: var(--white);
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .venue-summary {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .venue-summary-image {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
    }

    .venue-summary-info h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .venue-summary-info p {
      font-size: 13px;
      color: var(--muted);
    }

    .calendar-section {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    .date-selector {
      display: flex;
      flex-wrap: wrap; /* Desktop: t·ª± xu·ªëng d√≤ng, kh√¥ng scroll ngang to√†n trang */
      gap: 8px;
      padding: 8px 0;
      margin-bottom: 24px;
    }

    .date-option {
      min-width: 80px;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--white);
    }

    .date-option:hover {
      border-color: var(--green);
    }

    .date-option.selected {
      border-color: var(--green);
      background: #dcfce7;
      color: var(--green-dark);
      font-weight: 600;
    }

    .date-day {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .date-number {
      font-size: 18px;
      font-weight: 700;
    }

    .time-slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .time-slot {
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--white);
      position: relative;
    }

    .time-slot.available {
      border-color: var(--green);
      background: #dcfce7;
    }

    .time-slot.available:hover {
      background: #bbf7d0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(22, 163, 74, 0.2);
    }

    .time-slot.available.selected {
      background: var(--green);
      color: white;
      border-color: var(--green-dark);
    }

    .time-slot.booked {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .time-slot.past {
      background: #f3f4f6;
      border-color: var(--border);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .time-slot-price {
      font-size: 11px;
      margin-top: 4px;
      font-weight: 600;
    }

    .booking-summary {
      position: sticky;
      top: 80px;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--muted);
      font-size: 14px;
    }

    .summary-value {
      font-weight: 600;
      font-size: 14px;
    }

    .summary-total {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-total-label {
      font-size: 18px;
      font-weight: 700;
    }

    .summary-total-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--green-dark);
    }

    .selected-slots {
      margin-top: 16px;
      padding: 12px;
      background: #f0fdf4;
      border-radius: 12px;
      border: 1px solid #86efac;
    }

    .selected-slots-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--green-dark);
    }

    .selected-slots-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .selected-slot-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .remove-slot {
      color: var(--error);
      cursor: pointer;
      font-weight: 600;
    }

    .duration-selector {
      margin-bottom: 24px;
    }

    .duration-options {
      display: flex;
      gap: 8px;
    }

    .duration-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      transition: all 0.2s;
    }

    .duration-btn.selected {
      border-color: var(--green);
      background: #dcfce7;
      color: var(--green-dark);
    }

    .booking-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    /* Promo code section */
    .promo-code-section {
      margin: 16px 0;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid var(--border);
      max-width: 100%;
      box-sizing: border-box;
    }

    .promo-code-input-group {
      display: flex;
      gap: 8px;
      max-width: 100%;
    }

    .promo-code-input {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .promo-code-input:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .promo-code-btn {
      white-space: nowrap;
      padding: 10px 16px;
      font-size: 14px;
      flex-shrink: 0;
    }

    @media (max-width: 960px) {
      .booking-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .booking-summary {
        position: static;
        margin-top: 0;
      }

      .venue-summary {
        flex-wrap: wrap;
      }

      .venue-summary-image {
        width: 60px;
        height: 60px;
      }

      .venue-summary-info h2 {
        font-size: 16px;
      }

      .venue-summary-info p {
        font-size: 12px;
      }

      .time-slots-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
      }

      .time-slot {
        padding: 10px 8px;
        font-size: 13px;
      }
    }

    @media (max-width: 768px) {
      .page-header {
        padding: 16px 0;
      }

      .calendar-section {
        padding: 20px;
      }

      .booking-summary {
        padding: 20px;
      }

      .summary-title {
        font-size: 16px;
      }

      .summary-total-value {
        font-size: 20px;
      }

      .date-option {
        min-width: 70px;
        padding: 10px 12px;
      }

      .date-number {
        font-size: 16px;
      }

      .time-slots-grid {
        grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
        gap: 8px;
      }

      .time-slot {
        padding: 10px 6px;
        font-size: 12px;
      }

      .time-slot-price {
        font-size: 10px;
      }
    }

    @media (max-width: 640px) {
      .container {
        padding: 0 12px;
      }

      .page-header {
        padding: 12px 0;
        margin-bottom: 16px;
      }

      .venue-summary {
        gap: 10px;
      }

      .venue-summary-image {
        width: 50px;
        height: 50px;
      }

      .venue-summary-info h2 {
        font-size: 15px;
      }

      .venue-summary-info p {
        font-size: 11px;
      }

      .calendar-section {
        padding: 16px;
        margin-bottom: 16px;
      }

      .booking-summary {
        padding: 16px;
      }

      .summary-title {
        font-size: 15px;
        margin-bottom: 12px;
      }

      .summary-item {
        padding: 6px 0;
        font-size: 13px;
      }

      .summary-label,
      .summary-value {
        font-size: 13px;
      }

      .summary-total {
        margin-top: 12px;
        padding-top: 12px;
      }

      .summary-total-label {
        font-size: 16px;
      }

      .summary-total-value {
        font-size: 18px;
      }

      .date-option {
        min-width: 60px;
        padding: 8px 10px;
      }

      .date-day {
        font-size: 11px;
      }

      .date-number {
        font-size: 14px;
      }

      .duration-options {
        gap: 6px;
      }

      .duration-btn {
        padding: 8px;
        font-size: 13px;
      }

      .time-slots-grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 6px;
      }

      .time-slot {
        padding: 8px 4px;
        font-size: 11px;
      }

      .time-slot-price {
        font-size: 9px;
        margin-top: 2px;
      }

      /* Fix promo code section to prevent horizontal scroll */
      .promo-code-section {
        padding: 12px;
      }

      .promo-code-input-group {
        flex-direction: column;
        gap: 8px;
      }

      .promo-code-input,
      .promo-code-btn {
        width: 100%;
        min-width: 0;
      }

      .promo-code-btn {
        white-space: normal;
      }
    }

    @media (max-width: 480px) {
      .date-option {
        min-width: 55px;
        padding: 6px 8px;
      }

      .date-number {
        font-size: 13px;
      }

      .time-slots-grid {
        grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
      }

      .time-slot {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="logo-wrap">
        <a href="index.html">
          <svg class="logo-icon" viewBox="0 0 64 64" aria-hidden="true">
            <defs>
              <linearGradient id="sf-pin" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#16a34a" />
                <stop offset="100%" stop-color="#15803d" />
              </linearGradient>
            </defs>
            <path d="M32 4C22 4 14 12 14 22.2c0 11.2 9.7 22.3 16.2 30 1 1.2 2.7 1.2 3.7 0C40.3 44.5 50 33.4 50 22.2 50 12 42 4 32 4Z" fill="none" stroke="url(#sf-pin)" stroke-width="4" />
            <path d="M18 26h28" stroke="#16a34a" stroke-width="3" stroke-linecap="round" />
            <path d="M32 26v16" stroke="#16a34a" stroke-width="3" stroke-linecap="round" />
            <path d="M24 18l5 5 9-9" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <div class="brand-name">SportField</div>
        </a>
      </div>

      <nav>
        <a href="index.html">Trang ch·ªß</a>
        <div class="nav-dropdown">
          <a href="danh-sach-san.html">M√¥n th·ªÉ thao</a>
          <div class="dropdown-menu">
            <a href="danh-sach-san.html?sportType=football">B√≥ng ƒë√°</a>
            <a href="danh-sach-san.html?sportType=badminton">C·∫ßu l√¥ng</a>
            <a href="danh-sach-san.html?sportType=tennis">Tennis</a>
          </div>
        </div>
        <a href="uu-dai.html">∆Øu ƒë√£i</a>
        <a href="doi-tac.html">D√†nh cho ƒë·ªëi t√°c</a>
        <a href="tin-tuc.html">Tin t·ª©c</a>
        <div class="nav-dropdown">
          <a href="ho-tro.html">H·ªó tr·ª£</a>
          <div class="dropdown-menu">
            <a href="ho-tro.html">H·ªó tr·ª£ & FAQ</a>
            <a href="dieu-khoan.html">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
          </div>
        </div>
      </nav>

      <div class="header-cta">
        <a href="dang-nhap.html" class="btn-outline">ƒêƒÉng nh·∫≠p</a>
        <a href="dang-ky.html" class="btn">ƒêƒÉng k√Ω</a>
      </div>
    </div>
  </header>

  <main>
      <div class="page-header">
      <div class="container">
        <div class="venue-summary" id="venue-summary">
          <img src="" alt="S√¢n" class="venue-summary-image" id="venue-summary-image" />
          <div class="venue-summary-info">
            <h2 id="venue-summary-name">ƒêang t·∫£i...</h2>
            <p id="venue-summary-info">ƒêang t·∫£i th√¥ng tin...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="booking-layout">
        <div>
          <div class="calendar-section">
            <h2 class="section-title">Ch·ªçn ng√†y</h2>
            <div class="date-selector" id="date-selector">
              <!-- Dates will be generated by JavaScript -->
            </div>

            <div class="duration-selector">
              <div class="form-label">Th·ªùi l∆∞·ª£ng ƒë·∫∑t (gi·ªù)</div>
              <div class="duration-options">
                <button class="duration-btn" data-hours="1" onclick="handleSelectDuration(1)">1 gi·ªù</button>
                <button class="duration-btn" data-hours="2" onclick="handleSelectDuration(2)">2 gi·ªù</button>
                <button class="duration-btn selected" data-hours="3" onclick="handleSelectDuration(3)">3 gi·ªù</button>
              </div>
            </div>

            <h3 class="section-title" style="margin-top: 24px;">Ch·ªçn khung gi·ªù</h3>
            <div class="time-slots-grid" id="time-slots">
              <!-- Time slots will be generated by JavaScript -->
            </div>

            <div class="alert alert-info" style="margin-top: 24px;">
              üí° <strong>L∆∞u √Ω:</strong> M√†u xanh = C√≤n tr·ªëng ‚Ä¢ M√†u ƒë·ªè = ƒê√£ ƒë∆∞·ª£c ƒë·∫∑t ‚Ä¢ M√†u x√°m = ƒê√£ qua
            </div>
          </div>
        </div>

        <div>
          <div class="booking-summary">
            <div class="summary-title">T√≥m t·∫Øt ƒë·∫∑t s√¢n</div>
            
            <div class="summary-item">
              <span class="summary-label">S√¢n</span>
              <span class="summary-value">S√¢n 1</span>
            </div>

            <div id="selected-slots-container" class="selected-slots hidden">
              <div class="selected-slots-title">Khung gi·ªù ƒë√£ ch·ªçn:</div>
              <div class="selected-slots-list" id="selected-slots-list">
                <!-- Selected slots will be shown here -->
              </div>
            </div>

            <div class="summary-item">
              <span class="summary-label">S·ªë gi·ªù</span>
              <span class="summary-value" id="total-hours">0 gi·ªù</span>
            </div>

            <div class="summary-item">
              <span class="summary-label">Gi√° c∆° b·∫£n</span>
              <span class="summary-value" id="base-price">0‚Ç´</span>
            </div>

            <div class="summary-item">
              <span class="summary-label">Ph·ª• ph√≠ (n·∫øu c√≥)</span>
              <span class="summary-value" id="extra-fee">0‚Ç´</span>
            </div>

            <div class="promo-code-section">
              <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text);">M√£ gi·∫£m gi√°</div>
              <div class="promo-code-input-group">
                <input 
                  type="text" 
                  id="promo-code-input" 
                  placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
                  class="promo-code-input"
                  onkeypress="if(event.key === 'Enter') applyPromoCode()"
                />
                <button 
                  class="btn-outline promo-code-btn" 
                  onclick="applyPromoCode()"
                >
                  √Åp d·ª•ng
                </button>
              </div>
              <div id="promo-code-message" style="margin-top: 8px; font-size: 12px; min-height: 16px;">
                <span id="applied-promo-display" style="display: none;">
                  <span id="applied-promo-text"></span>
                  <span onclick="removePromoCode()" style="margin-left: 8px; color: var(--error); cursor: pointer; font-weight: 600;">‚úï</span>
                </span>
              </div>
            </div>

            <div class="summary-item">
              <span class="summary-label">Gi·∫£m gi√°</span>
              <span class="summary-value" style="color: var(--success);" id="discount">-0‚Ç´</span>
            </div>

            <div class="summary-total">
              <span class="summary-total-label">T·ªïng c·ªông</span>
              <span class="summary-total-value" id="total-price">0‚Ç´</span>
            </div>

            <button class="btn btn-large btn-block" id="proceed-btn" onclick="handleProceedToCheckout()" disabled style="margin-top: 24px;">
              Ti·∫øp t·ª•c thanh to√°n
            </button>

            <div class="alert alert-warning" id="login-warning" style="margin-top: 16px; font-size: 12px; display: none;">
              ‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ho√†n t·∫•t ƒë·∫∑t s√¢n
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="back-to-top" onclick="scrollToTop()" aria-label="L√™n ƒë·∫ßu trang">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 15l-6-6-6 6"/>
    </svg>
  </button>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="footer-logo">
            <svg class="logo-icon" viewBox="0 0 64 64" aria-hidden="true">
              <defs>
                <linearGradient id="sf-pin-footer" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#16a34a" />
                  <stop offset="100%" stop-color="#15803d" />
                </linearGradient>
              </defs>
              <path d="M32 4C22 4 14 12 14 22.2c0 11.2 9.7 22.3 16.2 30 1 1.2 2.7 1.2 3.7 0C40.3 44.5 50 33.4 50 22.2 50 12 42 4 32 4Z" fill="none" stroke="url(#sf-pin-footer)" stroke-width="4" />
              <path d="M18 26h28" stroke="#16a34a" stroke-width="3" stroke-linecap="round" />
              <path d="M32 26v16" stroke="#16a34a" stroke-width="3" stroke-linecap="round" />
              <path d="M24 18l5 5 9-9" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="brand-name">SportField</span>
          </div>
          <p class="section-sub">
            N·ªÅn t·∫£ng ƒë·∫∑t s√¢n th·ªÉ thao ƒëa m√¥n, gi√∫p b·∫°n k·∫øt n·ªëi d·ªÖ d√†ng v·ªõi h√†ng trƒÉm s√¢n t·∫≠p tr√™n to√†n qu·ªëc.
          </p>
        </div>

        <div>
          <div class="footer-title">Quy ƒë·ªãnh & h·ªó tr·ª£</div>
          <div class="footer-links">
            <a href="dieu-khoan.html">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
            <a href="dieu-khoan.html#privacy">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
            <a href="ho-tro.html">H∆∞·ªõng d·∫´n ƒë·∫∑t s√¢n</a>
            <a href="ho-tro.html">H·ªó tr·ª£ kh√°ch h√†ng</a>
          </div>
        </div>

        <div>
          <div class="footer-title">Li√™n h·ªá</div>
          <div class="footer-links">
            <span>Email: support@sportfield.vn</span>
            <span>Hotline: 0900 000 000</span>
            <span>Gi·ªù l√†m vi·ªác: 8:00 ‚Äì 22:00</span>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <span>¬© 2025 SportField. All rights reserved.</span>
        <span>Made with ‚ù§Ô∏è for sport lovers.</span>
      </div>
    </div>
  </footer>

  <script src="assets/js/mockData.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/header.js"></script>
  <script src="assets/js/alert.js"></script>
  <script src="assets/js/backToTop.js"></script>
  <script>
    // Configuration
    let venueId = 1; // Default, can be from URL
    let venue = null;
    let venueHours = { start: 6, end: 23 }; // Will be updated from venue
    let selectedDate = new Date();
    let selectedDuration = 3; // hours
    let selectedSlots = [];
    let appliedPromoCode = null; // Store applied promo code info

    // Get venueId from URL or sessionStorage
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('venue')) {
      venueId = parseInt(urlParams.get('venue'));
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      // Load venue info
      venue = await getVenueById(venueId);
      if (venue) {
        venueHours.start = venue.hours.start;
        venueHours.end = venue.hours.end;
        
        // Update venue summary
        const summaryName = document.getElementById('venue-summary-name');
        const summaryInfo = document.getElementById('venue-summary-info');
        const summaryImage = document.getElementById('venue-summary-image');
        
        if (summaryName) {
          summaryName.textContent = venue.name;
        }
        if (summaryInfo) {
          summaryInfo.textContent = `üìç ${venue.address} ‚Ä¢ Gi√° c∆° b·∫£n: ${formatPrice(venue.basePrice)}/gi·ªù`;
        }
        if (summaryImage && venue.images && venue.images.length > 0) {
          summaryImage.src = venue.images[0];
          summaryImage.alt = venue.name;
        }
      } else {
        // Venue not found, show error
        document.getElementById('venue-summary-name').textContent = 'Kh√¥ng t√¨m th·∫•y s√¢n';
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin s√¢n. Vui l√≤ng quay l·∫°i trang tr∆∞·ªõc.');
      }
      
      generateDateSelector();
      await generateTimeSlots();
      updateSummary();
      await updateLoginWarning();
    });

    // Generate date selector for next 14 days
    function generateDateSelector() {
      const container = document.getElementById('date-selector');
      const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
      
      for (let i = 0; i < 14; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        const dayName = days[date.getDay()];
        const dayNumber = date.getDate();
        const isToday = i === 0;
        
        const dateOption = document.createElement('div');
        dateOption.className = `date-option ${isToday ? 'selected' : ''}`;
        dateOption.innerHTML = `
          <div class="date-day">${dayName}</div>
          <div class="date-number">${dayNumber}</div>
        `;
        dateOption.onclick = async () => await selectDate(date);
        container.appendChild(dateOption);
      }
    }

    // Select date
    async function selectDate(date) {
      selectedDate = date;
      document.querySelectorAll('.date-option').forEach((el, index) => {
        const checkDate = new Date();
        checkDate.setDate(checkDate.getDate() + index);
        if (checkDate.toDateString() === date.toDateString()) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      selectedSlots = [];
      await generateTimeSlots();
      updateSummary();
    }

    // Generate time slots from API
    async function generateTimeSlots() {
      const container = document.getElementById('time-slots');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">ƒêang t·∫£i...</div>';
      
      if (!venue) {
        venue = await getVenueById(venueId);
      }
      
      const dateStr = selectedDate.toISOString().split('T')[0];
      const slots = await getAvailableSlots(venueId, dateStr, 'S√¢n 1');
      
      container.innerHTML = '';
      
      slots.forEach(slot => {
        const timeSlot = document.createElement('div');
        const isSelected = selectedSlots.includes(slot.time);
        
        let className = 'time-slot';
        if (!slot.available) className = 'time-slot booked';
        else if (isSelected) className = 'time-slot available selected';
        else className = 'time-slot available';

        timeSlot.className = className;
        timeSlot.innerHTML = `
          <div style="font-weight: 600; font-size: 14px;">${slot.time}</div>
          <div class="time-slot-price">${formatPrice(slot.price)}</div>
        `;

        if (slot.available) {
          timeSlot.onclick = async () => await toggleTimeSlot(slot.time, slot.price);
        }

        container.appendChild(timeSlot);
      });
    }

    // Toggle time slot selection
    async function toggleTimeSlot(timeString, price) {
      const index = selectedSlots.indexOf(timeString);
      if (index > -1) {
        selectedSlots.splice(index, 1);
      } else {
        // Check if adding this slot would exceed duration
        if (selectedSlots.length >= selectedDuration) {
          alert(`B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa ${selectedDuration} khung gi·ªù li√™n ti·∫øp.`);
          return;
        }
        selectedSlots.push(timeString);
        selectedSlots.sort();
      }
      await generateTimeSlots();
      updateSummary();
    }

    // Select duration (wrapper for onclick)
    async function handleSelectDuration(hours) {
      await selectDuration(hours);
    }

    // Select duration
    async function selectDuration(hours) {
      selectedDuration = hours;
      document.querySelectorAll('.duration-btn').forEach(btn => {
        if (parseInt(btn.dataset.hours) === hours) {
          btn.classList.add('selected');
        } else {
          btn.classList.remove('selected');
        }
      });
      
      // Reset selection if current selection exceeds new duration
      if (selectedSlots.length > hours) {
        selectedSlots = selectedSlots.slice(0, hours);
        await generateTimeSlots();
      }
      updateSummary();
    }

    // Update booking summary (REAL-TIME PRICE UPDATE)
    function updateSummary() {
      const totalHours = selectedSlots.length;
      const basePriceTotal = calculateBasePriceSync();
      const extraFee = calculateExtraFee();
      const discount = calculateDiscount();
      const totalPrice = basePriceTotal + extraFee - discount;

      document.getElementById('total-hours').textContent = `${totalHours} gi·ªù`;
      document.getElementById('base-price').textContent = formatPrice(basePriceTotal);
      document.getElementById('extra-fee').textContent = formatPrice(extraFee);
      document.getElementById('discount').textContent = `-${formatPrice(discount)}`;
      document.getElementById('total-price').textContent = formatPrice(totalPrice);

      // Show/hide selected slots
      const container = document.getElementById('selected-slots-container');
      const list = document.getElementById('selected-slots-list');
      
      if (selectedSlots.length > 0) {
        container.classList.remove('hidden');
        list.innerHTML = selectedSlots.map(slot => `
          <div class="selected-slot-item">
            <span>${slot}</span>
            <span class="remove-slot" onclick="handleRemoveSlot('${slot}')">‚úï</span>
          </div>
        `).join('');
      } else {
        container.classList.add('hidden');
      }

      // Enable/disable proceed button
      document.getElementById('proceed-btn').disabled = totalHours === 0;
    }

    // Calculate base price based on selected slots
    async function calculateBasePrice() {
      if (!venue) return 0;
      
      let total = 0;
      const dateStr = selectedDate.toISOString().split('T')[0];
      const slots = await getAvailableSlots(venueId, dateStr, 'S√¢n 1');
      
      selectedSlots.forEach(slotTime => {
        const slot = slots.find(s => s.time === slotTime);
        if (slot) {
          total += slot.price;
        }
      });
      return total;
    }
    
    // Sync version for immediate update
    function calculateBasePriceSync() {
      if (!venue) return 0;
      
      let total = 0;
      selectedSlots.forEach(slotTime => {
        const hour = parseInt(slotTime.split(':')[0]);
        let price = venue.basePrice;
        if (hour >= 17 && hour <= 21) price = venue.basePrice * 1.2;
        else if (hour >= 6 && hour <= 10) price = venue.basePrice * 0.85;
        total += price;
      });
      return total;
    }

    // Calculate extra fees
    function calculateExtraFee() {
      // Example: 50K extra for weekend
      const day = selectedDate.getDay();
      if (day === 0 || day === 6) {
        return 50000 * selectedSlots.length;
      }
      return 0;
    }

    // Calculate discount
    function calculateDiscount() {
      const baseTotal = calculateBasePriceSync();
      let discount = 0;
      
      // Discount from promo code
      if (appliedPromoCode) {
        if (appliedPromoCode.type === 'percentage') {
          discount = baseTotal * (appliedPromoCode.value / 100);
          if (appliedPromoCode.maxDiscount) {
            discount = Math.min(discount, appliedPromoCode.maxDiscount);
          }
        } else if (appliedPromoCode.type === 'fixed') {
          discount = appliedPromoCode.value;
        }
      }
      
      // Example: 10% discount for 3+ hours (if no promo code applied)
      if (!appliedPromoCode && selectedSlots.length >= 3) {
        discount = baseTotal * 0.1;
      }
      
      return discount;
    }

    // Apply promo code
    async function applyPromoCode() {
      const input = document.getElementById('promo-code-input');
      const messageDiv = document.getElementById('promo-code-message');
      const code = input.value.trim().toUpperCase();
      
      if (!code) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°</span>';
        return;
      }
      
      // Mock promo codes (in real app, this would come from API)
      const promoCodes = {
        'NEWUSER30': { type: 'percentage', value: 30, maxDiscount: 100000, description: 'Gi·∫£m 30% t·ªëi ƒëa 100.000‚Ç´' },
        'WEEKEND20': { type: 'percentage', value: 20, description: 'Gi·∫£m 20% cho cu·ªëi tu·∫ßn' },
        'MORNING15': { type: 'percentage', value: 15, description: 'Gi·∫£m 15% cho bu·ªïi s√°ng' },
        '50K': { type: 'fixed', value: 50000, description: 'Gi·∫£m 50.000‚Ç´' },
        '100K': { type: 'fixed', value: 100000, description: 'Gi·∫£m 100.000‚Ç´' }
      };
      
      const promo = promoCodes[code];
      
      if (promo) {
        // Check if promo applies to current booking
        let isValid = true;
        let reason = '';
        
        // Check date (for WEEKEND20)
        if (code === 'WEEKEND20') {
          const day = selectedDate.getDay();
          if (day !== 0 && day !== 6) {
            isValid = false;
            reason = 'M√£ n√†y ch·ªâ √°p d·ª•ng cho Th·ª© 7 v√† Ch·ªß nh·∫≠t';
          }
        }
        
        // Check time (for MORNING15)
        if (code === 'MORNING15') {
          const firstSlot = selectedSlots[0];
          if (firstSlot) {
            const hour = parseInt(firstSlot.split(':')[0]);
            if (hour >= 10) {
              isValid = false;
              reason = 'M√£ n√†y ch·ªâ √°p d·ª•ng cho khung gi·ªù tr∆∞·ªõc 10:00';
            }
          }
        }
        
        if (isValid) {
          appliedPromoCode = { ...promo, code: code };
          const appliedDisplay = document.getElementById('applied-promo-display');
          const appliedText = document.getElementById('applied-promo-text');
          appliedText.innerHTML = `<span style="color: var(--success);">‚úì ${promo.description}</span>`;
          appliedDisplay.style.display = 'inline';
          input.value = code;
          input.disabled = true;
          input.style.borderColor = 'var(--success)';
          updateSummary();
        } else {
          messageDiv.innerHTML = `<span style="color: var(--error);">${reason}</span>`;
          input.style.borderColor = 'var(--error)';
        }
      } else {
        appliedPromoCode = null;
        messageDiv.innerHTML = '<span style="color: var(--error);">M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá</span>';
        input.style.borderColor = 'var(--error)';
        updateSummary();
      }
    }
    
    // Remove promo code
    function removePromoCode() {
      appliedPromoCode = null;
      const input = document.getElementById('promo-code-input');
      input.value = '';
      input.disabled = false;
      input.style.borderColor = 'var(--border)';
      document.getElementById('applied-promo-display').style.display = 'none';
      document.getElementById('promo-code-message').innerHTML = '';
      updateSummary();
    }

    // Remove slot (wrapper for onclick)
    async function handleRemoveSlot(slot) {
      await removeSlot(slot);
    }

    // Remove slot
    async function removeSlot(slot) {
      const index = selectedSlots.indexOf(slot);
      if (index > -1) {
        selectedSlots.splice(index, 1);
        await generateTimeSlots();
        updateSummary();
      }
    }

    // Format price
    function formatPrice(price) {
      return new Intl.NumberFormat('vi-VN').format(Math.round(price)) + '‚Ç´';
    }

    // Check login status and update warning
    async function updateLoginWarning() {
      const user = await getCurrentUser();
      const warning = document.getElementById('login-warning');
      if (warning) {
        warning.style.display = user ? 'none' : 'block';
      }
    }

    // Proceed to checkout (wrapper for onclick)
    async function handleProceedToCheckout() {
      await proceedToCheckout();
    }

    // Proceed to checkout
    async function proceedToCheckout() {
      if (selectedSlots.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt khung gi·ªù');
        return;
      }
      
      // Check if user is logged in
      const user = await getCurrentUser();
      if (!user) {
        // Save booking data to sessionStorage to resume after login
        sessionStorage.setItem('bookingData', JSON.stringify({
          venueId: venueId,
          venueName: venue ? venue.name : 'S√¢n th·ªÉ thao',
          date: selectedDate.toISOString(),
          slots: selectedSlots,
          duration: selectedSlots.length,
          totalPrice: calculateBasePriceSync() + calculateExtraFee() - calculateDiscount(),
          field: 'S√¢n 1',
          promoCode: appliedPromoCode ? appliedPromoCode.code : null
        }));
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c');
        window.location.href = 'dang-nhap.html';
        return;
      }
      
      // User is logged in, save booking data and proceed
      const bookingData = {
        venueId: venueId,
        venueName: venue ? venue.name : 'S√¢n th·ªÉ thao',
        date: selectedDate.toISOString(),
        slots: selectedSlots,
        duration: selectedSlots.length,
        totalPrice: calculateBasePriceSync() + calculateExtraFee() - calculateDiscount(),
        field: 'S√¢n 1',
        promoCode: appliedPromoCode ? appliedPromoCode.code : null
      };
      
      sessionStorage.setItem('bookingData', JSON.stringify(bookingData));
      window.location.href = 'thanh-toan.html';
    }
  </script>
</body>
</html>

